FROM bitnami/kafka:3.6.2

# 设置时区
ENV TZ=Asia/Shanghai

# 降低内存使用
ENV KAFKA_HEAP_OPTS="-Xmx512m -Xms256m"

# KRaft 模式配置
ENV KAFKA_CFG_NODE_ID=0
ENV KAFKA_CFG_PROCESS_ROLES=controller,broker
ENV KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kratos_kafka:9093
ENV KAFKA_KRAFT_CLUSTER_ID=fMCL8kv1SWm87L_Md-I2hg
ENV KAFKA_CFG_METADATA_LOG_DIR=/bitnami/kafka/kraft-combined-logs
ENV KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
ENV KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER

# 监听器配置
ENV KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094
ENV KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://codekafka:9092,EXTERNAL://codekafka:9094
ENV KAFKA_CFG_INTER_BROKER_LISTENER_NAME=PLAINTEXT
ENV ALLOW_PLAINTEXT_LISTENER=yes

# 其他配置
ENV KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
ENV KAFKA_CFG_DELETE_TOPIC_ENABLE=true
ENV KAFKA_CFG_LOG_RETENTION_HOURS=168
ENV KAFKA_CFG_NUM_PARTITIONS=3
ENV KAFKA_CFG_DEFAULT_REPLICATION_FACTOR=1
ENV KAFKA_CFG_MIN_INSYNC_REPLICAS=1
ENV KAFKA_CFG_AUTO_LEADER_REBALANCE_ENABLE=true
ENV KAFKA_LOG4J_LOGGERS=kafka.controller=INFO,kafka.producer.async.DefaultEventHandler=INFO,state.change.logger=INFO
ENV KAFKA_LOG4J_ROOT_LOGLEVEL=WARN
ENV KAFKA_CFG_NUM_NETWORK_THREADS=3
ENV KAFKA_CFG_NUM_IO_THREADS=8
ENV KAFKA_CFG_SOCKET_SEND_BUFFER_BYTES=102400
ENV KAFKA_CFG_SOCKET_RECEIVE_BUFFER_BYTES=102400
ENV KAFKA_CFG_SOCKET_REQUEST_MAX_BYTES=104857600